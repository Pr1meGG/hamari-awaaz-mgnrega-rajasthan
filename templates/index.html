<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hamari Awaaz: MGNREGA Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom font and basic styling */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Custom class for performance rate colors */
      .performance-good {
        background-color: #d1fae5;
        color: #065f46;
        font-weight: bold;
      } /* Light Green */
      .performance-average {
        background-color: #fef9c3;
        color: #854d0e;
        font-weight: bold;
      } /* Light Yellow */
      .performance-poor {
        background-color: #fee2e2;
        color: #991b1b;
        font-weight: bold;
      } /* Light Red */
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "primary-dark": "#004d40" /* Deep Teal */,
              "primary-light": "#e0f2f1" /* Light Mint */,
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <!-- Header Section -->
    <header
      class="max-w-4xl mx-auto mb-8 p-4 bg-white rounded-xl shadow-lg border-t-4 border-primary-dark"
    >
      <h1
        class="text-3xl sm:text-4xl font-extrabold text-primary-dark tracking-tight"
      >
        Hamari Awaaz üì¢ - MGNREGA Performance
      </h1>
      <p class="text-sm text-gray-500 mt-1">
        (‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§°‡•ã‡§Æ‡•á‡§® ‡§∏‡•á ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü: ‡§Ü‡§ú)
      </p>
    </header>

    <!-- Location Information Placeholder (Bonus Feature) -->
    <div
      id="location-message"
      class="max-w-4xl mx-auto mb-6 p-4 rounded-lg bg-amber-100 border-l-4 border-amber-500 text-amber-800 font-medium text-base"
    >
      ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§§‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à... (‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡•Ä
      ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç)
    </div>

    <!-- Data Table Section -->
    <div
      class="max-w-4xl mx-auto overflow-x-auto bg-white rounded-xl shadow-lg"
    >
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-primary-light text-primary-dark">
          <tr>
            <th
              class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider rounded-tl-xl sm:px-6"
            >
              ‡§ú‡§º‡§ø‡§≤‡§æ (District)
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider sm:px-6"
            >
              ‡§ú‡•â‡§¨ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ú‡§æ‡§∞‡•Ä (Job Cards Issued)
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider sm:px-6"
            >
              ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§ (Workers Employed)
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider rounded-tr-xl sm:px-6"
            >
              ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§¶‡§∞ (%) (Performance Rate)
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for district in districts %}
          <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
            <td
              class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sm:px-6"
            >
              {{ district.district_name }}
            </td>
            <td
              class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 sm:px-6"
            >
              {{ district.Total_No_of_JobCards_issued | int }}
            </td>
            <td
              class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 sm:px-6"
            >
              {{ district.Total_No_of_Active_Workers | int }}
            </td>

            {% set rate = district.Performance_Rate %}
            <td
              class="px-4 py-4 whitespace-nowrap text-sm font-bold sm:px-6 {% if rate >= 50 %} performance-good {% elif rate >= 30 %} performance-average {% else %} performance-poor {% endif %}"
            >
              {{ "%.2f"|format(rate) }}%
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      // --- BONUS FEATURE: GEOLOCATION API ---

      const locationMessage = document.getElementById("location-message");

      function getLocation() {
        if (navigator.geolocation) {
          // Request location access with 15 second timeout for Docker/VM environments
          navigator.geolocation.getCurrentPosition(showPosition, showError, {
            timeout: 15000,
          });
        } else {
          locationMessage.innerHTML =
            "‚ùå Geolocation ‡§á‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
        }
      }

      // 1. Success Handler: Get Coordinates
      function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        // DEBUG STEP: Show raw coordinates to confirm success
        locationMessage.innerHTML = `<span class="text-green-800">‚úÖ ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§§‡§æ ‡§ö‡§≤‡§æ! Lat: ${lat.toFixed(
          4
        )}, Lon: ${lon.toFixed(4)}. ‡§ú‡§ø‡§≤‡•á ‡§ï‡•Ä ‡§§‡§≤‡§æ‡§∂...</span>`;

        // 2. Reverse Geocoding API (using Nominatim as a free example)
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            let district = "N/A";
            // Trying to get the administrative boundary name (county is often used for districts)
            if (data.address.county) {
              district = data.address.county;
            } else if (data.address.city) {
              district = data.address.city;
            } else if (data.address.town) {
              district = data.address.town;
            }

            if (district !== "N/A") {
              // Showing the message prominently
              locationMessage.innerHTML = `<span class="text-green-800">‚úÖ ‡§ï‡§Æ‡§æ‡§≤ ‡§π‡•à! ‡§Ü‡§™ **${district}** ‡§ú‡§º‡§ø‡§≤‡•á ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§π‡•à‡§Ç! ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§°‡•á‡§ü‡§æ ‡§®‡•Ä‡§ö‡•á ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§</span>`;
            } else {
              locationMessage.innerHTML =
                "‚ö†Ô∏è ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§§‡§æ ‡§ö‡§≤‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§ú‡§º‡§ø‡§≤‡•á ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§™‡§π‡§ö‡§æ‡§®‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§";
            }
          })
          .catch((error) => {
            console.error("Reverse Geocoding Error:", error);
            locationMessage.innerHTML =
              "‚ö†Ô∏è ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§§‡§æ ‡§ö‡§≤‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§ú‡§º‡§ø‡§≤‡§æ ‡§≤‡•Å‡§ï‡§Ö‡§™ ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§Ü ‡§ó‡§à‡•§ (API ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ)";
          });
      }

      // 3. Error Handler: If user denies location access
      function showError(error) {
        switch (error.code) {
          case error.PERMISSION_DENIED:
            locationMessage.innerHTML =
              "‚ùå ‡§∏‡•ç‡§•‡§æ‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§ú‡§º‡§ø‡§≤‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§æ ‡§∏‡§ï‡§§‡•á‡•§";
            break;
          case error.POSITION_UNAVAILABLE:
            locationMessage.innerHTML =
              "‚ùå ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§Ö‡§®‡•Å‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡•§ (Docker/VM ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Ø‡§æ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç)";
            break;
          case error.TIMEOUT:
            locationMessage.innerHTML =
              "‚ùå ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ (15s ‡§∏‡•Ä‡§Æ‡§æ)‡•§";
            break;
          default:
            locationMessage.innerHTML = `‚ùå ‡§è‡§ï ‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§∏‡•ç‡§•‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à (‡§ï‡•ã‡§°: ${error.code})‡•§`;
            break;
        }
      }

      // Start the location detection process
      getLocation();
    </script>
  </body>
</html>
